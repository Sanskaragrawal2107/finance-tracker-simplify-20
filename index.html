<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>finance-tracker-simplify</title>
    <meta name="description" content="Lovable Generated Project" />
    <meta name="author" content="Lovable" />
    <meta property="og:image" content="/og-image.png" />
  </head>

  <body>
    <div id="root"></div>
    <!-- IMPORTANT: DO NOT REMOVE THIS SCRIPT TAG OR THIS VERY COMMENT! -->
    <script>
      // Load GPT Engineer only in development (localhost) or with ?gpteng=1
      (function() {
        const isLocalhost = /^(localhost|127\.0\.0\.1|\[::1\])$/.test(location.hostname);
        const enabledByQuery = location.search.includes('gpteng=1');
        if (isLocalhost || enabledByQuery) {
          const s = document.createElement('script');
          s.src = 'https://cdn.gpteng.co/gptengineer.js';
          s.type = 'module';
          document.head.appendChild(s);
        }
      })();
    </script>
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- Service Worker Registration - Netlify-compatible -->
    <script>
      if ('serviceWorker' in navigator) {
        // Track service worker registration
        let swRegistration;
        
        // Function to notify service worker about visibility changes
        const notifyServiceWorkerVisibility = () => {
          if (swRegistration && swRegistration.active) {
            swRegistration.active.postMessage({
              type: 'VISIBILITY_CHANGE',
              state: document.visibilityState
            });
          }
        };
        
        // Get the correct service worker path for Netlify
        const getServiceWorkerUrl = () => {
          // Get the base URL from the current location
          const baseUrl = window.location.origin;
          // Return the full path to the service worker
          return `${baseUrl}/service-worker.js`;
        };
        
        // Force update of service worker
        const updateServiceWorker = async () => {
          if (swRegistration) {
            try {
              await swRegistration.update();
              console.log('Service worker updated');
            } catch (error) {
              console.error('Error updating service worker:', error);
            }
          }
        };
        
        // Check for stale service worker
        const checkServiceWorkerFreshness = () => {
          // If tab was hidden for more than 5 minutes, update SW on visibility change
          document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
              const lastHiddenTime = parseInt(sessionStorage.getItem('lastHiddenTime') || '0');
              const now = Date.now();
              
              // Only update if it's been more than 5 minutes
              if (lastHiddenTime > 0 && now - lastHiddenTime > 5 * 60 * 1000) {
                console.log('Tab hidden for more than 5 minutes, updating service worker');
                updateServiceWorker();
              }
              
              // Reset the timer
              sessionStorage.removeItem('lastHiddenTime');
            } else {
              // Save when the tab was hidden
              sessionStorage.setItem('lastHiddenTime', Date.now().toString());
            }
          });
        };
        
        // Listen for visibility changes to notify service worker
        document.addEventListener('visibilitychange', notifyServiceWorkerVisibility);
        
        // Register the service worker when the page loads
        window.addEventListener('load', () => {
          navigator.serviceWorker.register(getServiceWorkerUrl(), {
            scope: '/',
            updateViaCache: 'none' // Never use cached service worker
          })
            .then(registration => {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
              swRegistration = registration;
              
              // Initial visibility state
              notifyServiceWorkerVisibility();
              
              // Check for service worker updates every 30 minutes
              setInterval(() => {
                updateServiceWorker();
              }, 30 * 60 * 1000);
              
              // When the controllerchange event fires, the page has a new service worker
              navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('New service worker activated');
                
                // Send visibility state to new controller
                if (navigator.serviceWorker.controller) {
                  notifyServiceWorkerVisibility();
                }
              });
              
              // Set up freshness checking
              checkServiceWorkerFreshness();
            })
            .catch(error => {
              console.log('ServiceWorker registration failed: ', error);
            });
        });
        // Removed legacy network connectivity pings and Supabase HEAD checks
        // to avoid interfering with Supabase auth/session refresh and to
        // prevent noisy console warnings/timeouts.
      }
    </script>
  </body>
</html>
